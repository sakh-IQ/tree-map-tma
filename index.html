<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding-bottom: 80px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã */
    #map {
      opacity: 0;
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º attribution OpenStreetMap –ø–æ–¥ –Ω–∞—à–µ–π –ø–∞–Ω–µ–ª—å—é */
    .leaflet-control-attribution {
      position: fixed !important;
      bottom: -50px !important;
      z-index: 500 !important;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ä–µ–≤–∞ */
    .tree-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .tree-modal.show {
      display: flex;
      animation: modalAppear 0.3s ease-out;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .tree-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    
    .tree-option {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      background: white;
      font-size: 16px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .tree-option:hover {
      border-color: #3498db;
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
    }
    
    .tree-option.infected {
      border-color: #e74c3c;
    }
    
    .tree-option.infected:hover {
      border-color: #c0392b;
      background: #fdf2f2;
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
    }
    
    .tree-option.dead {
      border-color: #2c3e50;
    }
    
    .tree-option.dead:hover {
      border-color: #1a252f;
      background: #f8f9fa;
      box-shadow: 0 5px 15px rgba(44, 62, 80, 0.2);
    }
    
    .option-emoji {
      font-size: 24px;
      margin-right: 10px;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #95a5a6;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .close-modal:hover {
      color: #7f8c8d;
    }

    .custom-popup {
      font-size: 14px;
      max-width: 250px;
      font-family: inherit;
      line-height: 1.4;
    }
    .custom-popup b {
      color: #2c3e50;
    }
    .custom-popup hr {
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, #ddd, transparent);
    }

    .popup-btn {
      display: inline-block;
      margin: 4px 2px;
      padding: 8px 12px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .popup-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .popup-btn:active {
      transform: translateY(0);
    }
    .popup-btn.danger {
      background: #e74c3c;
    }
    .popup-btn.success {
      background: #27ae60;
    }
    .popup-btn.warning {
      background: #f39c12;
      color: white;
    }
    .popup-btn.user-delete {
      background: #e67e22;
      color: white;
    }
    .popup-btn.infected {
      background: #e74c3c;
    }
    .popup-btn.dry {
      background: #2c3e50;
    }

    .status-legend {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 8px;
      background: rgba(255,255,255,0.15);
      padding: 8px 12px;
      border-radius: 25px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .legend-item:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .app-title {
      font-weight: 600;
      font-size: 16px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }
    .help-text {
      font-size: 12px; 
      opacity: 0.9;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* –ó–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ –æ–∫–Ω–æ */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 3000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }
    
    .loading-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }
    
    .loading-content {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      max-width: 300px;
      width: 90%;
    }
    
    .loading-spinner {
      font-size: 40px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 16px;
      color: #2c3e50;
      font-weight: 500;
      margin-bottom: 10px;
      min-height: 24px;
    }
    
    .loading-subtext {
      font-size: 12px;
      color: #7f8c8d;
      font-style: italic;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ä–µ–≤–∞ -->
<div class="tree-modal" id="treeModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeTreeModal()">&times;</button>
    <div class="tree-icon">üå≥</div>
    <div class="modal-title">–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å –¥–µ—Ä–µ–≤–æ–º?</div>
    
    <button class="tree-option infected" onclick="selectTreeType('–ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">ü¶†</span>
      –ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
    </button>
    
    <button class="tree-option dead" onclick="selectTreeType('–ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">üçÇ</span>
      –ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ
    </button>
  </div>
</div>

<!-- –ó–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner">üå≥</div>
    <div class="loading-text" id="loadingText">–°–≤—è–∑—ã–≤–∞—é—Å—å —Å –ª–µ—Å–æ–º...</div>
    <div class="loading-subtext">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
  </div>
</div>

<div class="status-legend">
  <div class="app-title">üå≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ—Ä–µ–≤—å–µ–≤</div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FFA500;"></div>
    <span>–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FF0000;"></div>
    <span>–ó–∞—Ä–∞–∂–µ–Ω–æ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #2c3e50;"></div>
    <span>–ó–∞—Å–æ—Ö–ª–æ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #00AA00;"></div>
    <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
  </div>
  
  <div class="help-text">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL!!!
const API_URL = 'https://script.google.com/macros/s/AKfycbxAjthFQ6G8NRC-9uPujT4_Hb1_34XE9rw8gbTXZ1LvwsYK1HVc8sCI55qrfqruxug/exec';

const tg = window.Telegram?.WebApp || {};
let userId = tg.initDataUnsafe?.user?.id || 0;
let userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';

// –†–ï–ñ–ò–ú –†–ê–ó–†–ê–ë–û–¢–ö–ò - –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const DEV_MODE = false; // true = —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø —Å –ü–ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, false = —Ç–æ–ª—å–∫–æ Telegram
const DEV_USER_ID = 999999999; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–π —Ä–µ–∞–ª—å–Ω—ã–π Telegram ID –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ù–ï –∞–¥–º–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!)
const DEV_USER_NAME = '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';

if (DEV_MODE && userId === 0) {
  userId = DEV_USER_ID;
  userName = DEV_USER_NAME;
  console.log('üöß –†–ï–ñ–ò–ú –†–ê–ó–†–ê–ë–û–¢–ö–ò: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–π User ID:', userId);
  console.log('‚ö†Ô∏è  –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø—Ä–∞–≤–∞ –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ Google Sheets!');
  
  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  document.addEventListener('DOMContentLoaded', function() {
    const devWarning = document.createElement('div');
    devWarning.style.cssText = `
      position: fixed; top: 10px; right: 10px; z-index: 9999;
      background: #ff6b6b; color: white; padding: 8px 12px;
      border-radius: 8px; font-size: 12px; font-weight: bold;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    `;
    devWarning.textContent = 'üöß –†–ï–ñ–ò–ú –†–ê–ó–†–ê–ë–û–¢–ö–ò';
    document.body.appendChild(devWarning);
    
    // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => devWarning.remove(), 5000);
  });
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ –≤ Telegram (—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
if (!DEV_MODE && (!window.Telegram?.WebApp || userId === 0)) {
  document.body.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; height: 100vh; background: #f5f5f5; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
      <div style="text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 400px;">
        <div style="font-size: 60px; margin-bottom: 20px;">üö´</div>
        <h2 style="color: #e74c3c; margin-bottom: 15px;">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
        <p style="color: #7f8c8d; line-height: 1.5;">–≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Telegram Mini App.</p>
        <p style="color: #7f8c8d; line-height: 1.5; margin-top: 20px; font-size: 14px;">–û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞ –∏–ª–∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
      </div>
    </div>
  `;
  throw new Error('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ Telegram');
}

let isAdmin = false;
let isBlocked = false;
let currentClickCoords = null;
let loadingInterval = null;

// –ó–∞–±–∞–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
const loadingMessages = [
  "–°–≤—è–∑—ã–≤–∞—é—Å—å —Å –ª–µ—Å–æ–º...",
  "–ò—â—É —É–∫–∞–∑–∞–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ...",
  "–ó–æ–≤—É –¥–µ–Ω–¥—Ä–æ–ª–æ–≥–æ–≤...",
  "–ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É—é—Å—å —Å –±–µ–ª–∫–∞–º–∏...",
  "–ü—Ä–æ–≤–µ—Ä—è—é —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ—Ä–Ω–µ–π...",
  "–°—á–∏—Ç–∞—é –≥–æ–¥–∏—á–Ω—ã–µ –∫–æ–ª—å—Ü–∞...",
  "–°–ø—Ä–∞—à–∏–≤–∞—é —É –¥—è—Ç–ª–æ–≤...",
  "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ª–∏—Å—Ç–≤—É...",
  "–û–±—â–∞—é—Å—å —Å –ª–µ—Å–Ω–∏—á–∏–º...",
  "–ó–∞–ø–∏—Å—ã–≤–∞—é –≤ –ª–µ—Å–Ω—É—é –∫–Ω–∏–≥—É...",
  "–£–≤–µ–¥–æ–º–ª—è—é –ª–µ—Å–Ω—ã—Ö –¥—É—Ö–æ–≤...",
  "–ü—Ä–æ–≤–µ—Ä—è—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏—Ä–æ–¥—ã..."
];

function showLoading() {
  const overlay = document.getElementById('loadingOverlay');
  const textElement = document.getElementById('loadingText');
  
  overlay.classList.add('show');
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤–æ–µ —Å–ª—É—á–∞–π–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  let currentMessage = Math.floor(Math.random() * loadingMessages.length);
  textElement.textContent = loadingMessages[currentMessage];
  
  // –ú–µ–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 1.5 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–µ
  loadingInterval = setInterval(() => {
    let newMessage;
    // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ
    do {
      newMessage = Math.floor(Math.random() * loadingMessages.length);
    } while (newMessage === currentMessage && loadingMessages.length > 1);
    
    currentMessage = newMessage;
    textElement.textContent = loadingMessages[currentMessage];
  }, 1500);
}

function hideLoading() {
  const overlay = document.getElementById('loadingOverlay');
  overlay.classList.remove('show');
  
  if (loadingInterval) {
    clearInterval(loadingInterval);
    loadingInterval = null;
  }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
if (tg.ready) {
  tg.ready();
  tg.expand();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
var map = L.map('map').setView([46.963983, 142.753996], 17);

var bounds = L.latLngBounds(
	L.latLng(46.969532, 142.744199),
	L.latLng(46.960354, 142.764873)
);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
loadData();

function loadData() {
  fetch(API_URL + '?user_id=' + userId)
    .then(response => {
      return response.text().then(text => {
        try {
          const json = JSON.parse(text);
          return json;
        } catch (e) {
          throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}...`);
        }
      });
    })
    .then(data => {
      isAdmin = data.isAdmin;
      isBlocked = data.isBlocked;
      
      // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
      console.log('User ID:', userId);
      console.log('Is Admin:', isAdmin);
      console.log('Is Blocked:', isBlocked);
      
      if (isBlocked) {
        alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.');
        return;
      }
      
      displayPoints(data.points || []);
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    });
}

function displayPoints(points) {
  // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  points.forEach(pt => {
    const color = getColor(pt.status);
    const marker = L.circleMarker([pt.lat, pt.lng], {
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 8,
      weight: 2
    }).addTo(map);

    let popupContent = `<div class="custom-popup">
      <b>–¢–∏–ø:</b> ${pt.type}<br/>
      <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–∞–∑–≤–∞–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –∏–ª–∏ –∏–Ω–æ–µ):</b> ${pt.comment || '–ù–µ—Ç'}<br/>
      <b>–°—Ç–∞—Ç—É—Å:</b> ${pt.status}<br/>
      <b>–î–∞—Ç–∞:</b> ${formatDate(pt.date)}<br/>
      <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_name || 'ID: ' + pt.user_id}<br/>`;

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–æ–º –æ—Ç–º–µ—Ç–∫–∏
    const isOwner = pt.user_id == userId;

    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–æ—á–∫–∏
    console.log(`Point ${pt.id}: owner=${pt.user_id}, current=${userId}, isOwner=${isOwner}, isAdmin=${isAdmin}`);

    if (isAdmin || isOwner) {
      popupContent += `<hr style="margin: 8px 0;">`;
      
      // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∞–¥–º–∏–Ω –∏–º–µ–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞)
      if (isAdmin) {
        console.log(`Adding admin buttons for point ${pt.id}`);
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–µ—Ä–µ–≤–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        if (pt.type === '–ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ') {
          popupContent += `<button class="popup-btn infected" onclick="updateStatus(${pt.id}, '–ó–∞—Ä–∞–∂–µ–Ω–æ')">ü¶† –ó–∞—Ä–∞–∂–µ–Ω–æ</button>`;
        } else if (pt.type === '–ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ') {
          popupContent += `<button class="popup-btn dry" onclick="updateStatus(${pt.id}, '–ó–∞—Å–æ—Ö–ª–æ')">üçÇ –ó–∞—Å–æ—Ö–ª–æ</button>`;
        }
        
        popupContent += `<button class="popup-btn" onclick="updateStatus(${pt.id}, '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ')">üîß –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</button><br/>
        <button class="popup-btn danger" onclick="deletePoint(${pt.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
        <button class="popup-btn warning" onclick="blockUser(${pt.user_id}, '${pt.user_name}')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
      }
      // –ö–Ω–æ–ø–∫–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –æ—Ç–º–µ—Ç–∫–∏ (–µ—Å–ª–∏ –æ–Ω –Ω–µ –∞–¥–º–∏–Ω)
      else if (isOwner) {
        console.log(`Adding owner buttons for point ${pt.id}`);
        popupContent += `<button class="popup-btn user-delete" onclick="deleteOwnPoint(${pt.id})">üóë –£–¥–∞–ª–∏—Ç—å –º–æ—é –æ—Ç–º–µ—Ç–∫—É</button>`;
      }
    }

    popupContent += `</div>`;
    marker.bindPopup(popupContent);
  });
}

function getColor(status) {
  switch(status) {
    case '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ': return '#FFA500';      // –û—Ä–∞–Ω–∂–µ–≤—ã–π
    case '–ó–∞—Ä–∞–∂–µ–Ω–æ': return '#FF0000';        // –ö—Ä–∞—Å–Ω—ã–π (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ —Å "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ")
    case '–ó–∞—Å–æ—Ö–ª–æ': return '#2c3e50';         // –ß–µ—Ä–Ω—ã–π (–Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å)
    case '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ': return '#00AA00';      // –ó–µ–ª–µ–Ω—ã–π
    default: return '#808080';                // –°–µ—Ä—ã–π (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU');
}

// –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
map.on('click', function(e) {
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ Telegram ID (–∫—Ä–æ–º–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  if (!DEV_MODE && (!userId || userId === 0)) {
    alert('–û—à–∏–±–∫–∞: –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ Telegram!');
    return;
  }
  
  if (isBlocked) {
    alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
    return;
  }
  
  if (!bounds.contains(e.latlng)) {
    alert('–û—Ç–º–µ—Ç–∫–∏ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∫–∞!');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  currentClickCoords = e.latlng;
  showTreeModal();
});

function showTreeModal() {
  document.getElementById('treeModal').classList.add('show');
}

function closeTreeModal() {
  document.getElementById('treeModal').classList.remove('show');
  currentClickCoords = null;
}

function selectTreeType(type) {
  if (!currentClickCoords) {
    alert('–û—à–∏–±–∫–∞: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const lat = currentClickCoords.lat;
  const lng = currentClickCoords.lng;
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—ç—Ç–æ –æ–±–Ω—É–ª–∏—Ç currentClickCoords)
  closeTreeModal();
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  const comment = prompt(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ "${type}" (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):`, "") || "";
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
  addPoint(lat, lng, type, comment);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.getElementById('treeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeTreeModal();
  }
});

function addPoint(lat, lng, type, comment) {
  // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π (–∫—Ä–æ–º–µ —Ä–µ–∂–∏–º–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
  if (!DEV_MODE && (!userId || userId === 0)) {
    alert('–û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π Telegram ID!');
    return;
  }
  
  showLoading(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
  
  try {
    const data = {
      action: 'add',
      user_id: userId,
      user_name: userName,
      lat: lat,
      lng: lng,
      type: type,
      comment: comment
    };
    
    // –ü–æ–ø—Ä–æ–±—É–µ–º —Å–Ω–∞—á–∞–ª–∞ POST
    fetch(API_URL, {
      method: 'POST',
      mode: 'cors',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return response.text().then(text => {
        try {
          const json = JSON.parse(text);
          return json;
        } catch (e) {
          throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ${text.substring(0, 100)}...`);
        }
      });
    })
    .then(result => {
      hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
      
      if (result.result === 'success') {
        alert(`üéâ –°–ø–∞—Å–∏–±–æ! –û—Ç–º–µ—Ç–∫–∞ "${type}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. ID: ${result.id}`);
        setTimeout(() => loadData(), 1000);
      } else if (result.error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + result.error);
      } else {
        alert('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
      }
    })
    .catch(error => {
      // –ï—Å–ª–∏ POST –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ GET (–Ω–æ –∑–∞–≥—Ä—É–∑–∫—É –Ω–µ —É–±–∏—Ä–∞–µ–º)
      tryGetMethod(lat, lng, type, comment);
    });
    
  } catch (error) {
    hideLoading();
    alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
  }
}

function tryGetMethod(lat, lng, type, comment) {
  const params = new URLSearchParams({
    action: 'add',
    user_id: userId,
    user_name: userName,
    lat: lat,
    lng: lng,
    type: type,
    comment: comment
  });
  
  const getUrl = API_URL + '?' + params.toString();
  
  fetch(getUrl, {
    method: 'GET',
    mode: 'cors'
  })
  .then(response => {
    return response.text();
  })
  .then(text => {
    hideLoading(); // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
    
    try {
      const result = JSON.parse(text);
      if (result.result === 'success') {
        alert(`üéâ –°–ø–∞—Å–∏–±–æ! –û—Ç–º–µ—Ç–∫–∞ "${type}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. ID: ${result.id}`);
        setTimeout(() => loadData(), 1000);
      } else {
        alert('
