<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Карта состояния деревьев</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .custom-popup {
      font-size: 14px;
      max-width: 250px;
    }
    .popup-btn {
      display: inline-block;
      margin: 4px 2px;
      padding: 6px 10px;
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .popup-btn:hover {
      background: #0056b3;
    }
    .popup-btn.danger {
      background: #dc3545;
    }
    .popup-btn.success {
      background: #28a745;
    }
    .status-legend {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 12px;
      z-index: 1000;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 2px 0;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      border: 2px solid #333;
    }
    .debug {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      z-index: 1000;
      max-width: 200px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="debug" id="debug">
  Загрузка...
</div>

<div class="status-legend">
  <div class="legend-item">
    <div class="legend-color" style="background: #FFA500;"></div>
    <span>Подозрение</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #FF0000;"></div>
    <span>Подтверждено</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: #00AA00;"></div>
    <span>Обработано</span>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// ЗАМЕНИТЕ НА ВАШ URL!!!
const API_URL = 'https://script.google.com/macros/s/AKfycbwevaTqlAsTiWdrq2w25a6O8vqgTdVLo2n1aj8PUgt2QF4X4jmq5OjjUbDoOTVxRNo/exec';

const tg = window.Telegram?.WebApp || {};
const userId = tg.initDataUnsafe?.user?.id || 0;
const userName = tg.initDataUnsafe?.user?.first_name || 'Гость';

let isAdmin = false;
let isBlocked = false;

function log(message) {
  console.log(message);
  document.getElementById('debug').innerHTML = message;
}

log(`User: ${userName} (${userId})`);

// Настройка Telegram
if (tg.ready) {
  tg.ready();
  tg.expand();
}

// Инициализация карты
var map = L.map('map').setView([46.963983, 142.753996], 17);

var bounds = L.latLngBounds(
  L.latLng(46.966238, 142.747308),
  L.latLng(46.961201, 142.760771)
);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap'
}).addTo(map);

// Загрузка данных
loadData();

function loadData() {
  log('Загружаю данные...');
  
  fetch(API_URL + '?user_id=' + userId)
    .then(response => {
      log(`Ответ: ${response.status}`);
      return response.json();
    })
    .then(data => {
      log(`Точек: ${data.points.length}, Админ: ${data.isAdmin}`);
      
      isAdmin = data.isAdmin;
      isBlocked = data.isBlocked;
      
      if (isBlocked) {
        alert('Вы заблокированы!');
        return;
      }
      
      displayPoints(data.points);
    })
    .catch(error => {
      log('Ошибка: ' + error.message);
      console.error('Error:', error);
    });
}

function displayPoints(points) {
  // Очищаем маркеры
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  points.forEach(pt => {
    const color = getColor(pt.status);
    const marker = L.circleMarker([pt.lat, pt.lng], {
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 8,
      weight: 2
    }).addTo(map);

    let popupContent = `<div class="custom-popup">
      <b>Тип:</b> ${pt.type}<br/>
      <b>Комментарий:</b> ${pt.comment || 'Нет'}<br/>
      <b>Статус:</b> ${pt.status}<br/>
      <b>Дата:</b> ${formatDate(pt.date)}<br/>
      <b>Пользователь:</b> ${pt.user_name || 'ID: ' + pt.user_id}<br/>`;

    if (isAdmin) {
      popupContent += `<hr style="margin: 8px 0;">
        <button class="popup-btn success" onclick="updateStatus(${pt.id}, 'Подтверждено')">Подтвердить</button>
        <button class="popup-btn" onclick="updateStatus(${pt.id}, 'Обработано')">Обработано</button><br/>
        <button class="popup-btn danger" onclick="deletePoint(${pt.id})">Удалить</button>`;
    }

    popupContent += `</div>`;
    marker.bindPopup(popupContent);
  });
}

function getColor(status) {
  switch(status) {
    case 'Подозрение': return '#FFA500';
    case 'Подтверждено': return '#FF0000';
    case 'Обработано': return '#00AA00';
    default: return '#808080';
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU');
}

// Клик по карте для добавления точки
map.on('click', function(e) {
  if (isBlocked) {
    alert('Вы заблокированы!');
    return;
  }
  
  if (!bounds.contains(e.latlng)) {
    alert('Только в пределах парка!');
    return;
  }
  
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  
  const types = ['Заражённое дерево', 'Засохшее дерево', 'Повреждённое дерево', 'Опасное дерево'];
  
  const choice = prompt(`Тип проблемы:\n1. Заражённое\n2. Засохшее\n3. Повреждённое\n4. Опасное\n\nВведите номер:`, '1');
  
  if (!choice || choice < 1 || choice > 4) return;
  
  const type = types[parseInt(choice) - 1];
  const comment = prompt("Комментарий (необязательно):", "") || "";
  
  addPoint(lat, lng, type, comment);
});

function addPoint(lat, lng, type, comment) {
  log('Добавляю точку...');
  
  const data = {
    action: 'add',
    user_id: userId,
    user_name: userName,
    lat: lat,
    lng: lng,
    type: type,
    comment: comment
  };
  
  fetch(API_URL, {
    method: 'POST',
    mode: 'cors',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data)
  })
  .then(response => response.json())
  .then(result => {
    log('Результат: ' + result.result);
    
    if (result.result === 'success') {
      alert(`Точка добавлена! ID: ${result.id}`);
      loadData(); // Перезагружаем
    } else {
      alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
    }
  })
  .catch(error => {
    log('Ошибка POST: ' + error.message);
    alert('Ошибка при добавлении точки');
  });
}

function updateStatus(id, status) {
  if (!isAdmin) {
    alert('Нет прав');
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    mode: 'cors',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'update',
      id: id,
      status: status
    })
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'updated') {
      alert('Статус обновлён!');
      loadData();
    } else {
      alert('Ошибка обновления');
    }
  })
  .catch(error => {
    alert('Ошибка: ' + error.message);
  });
}

function deletePoint(id) {
  if (!isAdmin) {
    alert('Нет прав');
    return;
  }
  
  if (!confirm('Удалить точку?')) return;
  
  fetch(API_URL, {
    method: 'POST',
    mode: 'cors',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      action: 'delete',
      id: id
    })
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'deleted') {
      alert('Точка удалена!');
      loadData();
    } else {
      alert('Ошибка удаления');
    }
  })
  .catch(error => {
    alert('Ошибка: ' + error.message);
  });
}
</script>

</body>
</html>
