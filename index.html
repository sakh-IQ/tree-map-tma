<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding-bottom: 80px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã */
    #map {
      opacity: 0;
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º attribution OpenStreetMap –ø–æ–¥ –Ω–∞—à–µ–π –ø–∞–Ω–µ–ª—å—é */
    .leaflet-control-attribution {
      position: fixed !important;
      bottom: -50px !important;
      z-index: 500 !important;
    }
    .custom-popup {
      font-size: 14px;
      max-width: 250px;
      font-family: inherit;
      line-height: 1.4;
    }
    .custom-popup b {
      color: #2c3e50;
    }
    .custom-popup hr {
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, #ddd, transparent);
    }
    .popup-btn {
      display: inline-block;
      margin: 4px 2px;
      padding: 8px 12px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .popup-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .popup-btn:active {
      transform: translateY(0);
    }
    .popup-btn.danger {
      background: #e74c3c;
    }
    .popup-btn.success {
      background: #27ae60;
    }
    .popup-btn.warning {
      background: #f39c12;
      color: white;
    }
    .status-legend {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 8px;
      background: rgba(255,255,255,0.15);
      padding: 8px 12px;
      border-radius: 25px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .legend-item:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .app-title {
      font-weight: 600;
      font-size: 16px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }
    .help-text {
      font-size: 12px; 
      opacity: 0.9;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ä–µ–≤–∞ -->
<div class="tree-modal" id="treeModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeTreeModal()">&times;</button>
    <div class="tree-icon">üå≥</div>
    <div class="modal-title">–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å –¥–µ—Ä–µ–≤–æ–º?</div>
    
    <button class="tree-option infected" onclick="selectTreeType('–ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">ü¶†</span>
      –ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
    </button>
    
    <button class="tree-option dead" onclick="selectTreeType('–ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">üçÇ</span>
      –ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ
    </button>
  </div>
</div>

<div class="status-legend">
  <div class="app-title">üå≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ—Ä–µ–≤—å–µ–≤</div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FFA500;"></div>
    <span>–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FF0000;"></div>
    <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #00AA00;"></div>
    <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
  </div>
  
  <div class="help-text">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL!!!
const API_URL = 'https://script.google.com/macros/s/AKfycbwevaTqlAsTiWdrq2w25a6O8vqgTdVLo2n1aj8PUgt2QF4X4jmq5OjjUbDoOTVxRNo/exec';

const tg = window.Telegram?.WebApp || {};
const userId = tg.initDataUnsafe?.user?.id || 0;
const userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';

let isAdmin = false;
let isBlocked = false;
let currentClickCoords = null; // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
if (tg.ready) {
  tg.ready();
  tg.expand();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
var map = L.map('map').setView([46.963983, 142.753996], 17);

var bounds = L.latLngBounds(
  L.latLng(46.966238, 142.747308),
  L.latLng(46.961201, 142.760771)
);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
loadData();

function loadData() {
  fetch(API_URL + '?user_id=' + userId)
    .then(response => response.json())
    .then(data => {
      isAdmin = data.isAdmin;
      isBlocked = data.isBlocked;
      
      if (isBlocked) {
        alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.');
        return;
      }
      
      displayPoints(data.points);
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    });
}

function displayPoints(points) {
  // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  points.forEach(pt => {
    const color = getColor(pt.status);
    const marker = L.circleMarker([pt.lat, pt.lng], {
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 8,
      weight: 2
    }).addTo(map);

    let popupContent = `<div class="custom-popup">
      <b>–¢–∏–ø:</b> ${pt.type}<br/>
      <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${pt.comment || '–ù–µ—Ç'}<br/>
      <b>–°—Ç–∞—Ç—É—Å:</b> ${pt.status}<br/>
      <b>–î–∞—Ç–∞:</b> ${formatDate(pt.date)}<br/>
      <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_name || 'ID: ' + pt.user_id}<br/>`;

    if (isAdmin) {
      popupContent += `<hr style="margin: 8px 0;">
        <button class="popup-btn success" onclick="updateStatus(${pt.id}, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="popup-btn" onclick="updateStatus(${pt.id}, '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ')">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</button><br/>
        <button class="popup-btn danger" onclick="deletePoint(${pt.id})">–£–¥–∞–ª–∏—Ç—å</button>`;
    }

    popupContent += `</div>`;
    marker.bindPopup(popupContent);
  });
}

function getColor(status) {
  switch(status) {
    case '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ': return '#FFA500';
    case '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': return '#FF0000';
    case '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ': return '#00AA00';
    default: return '#808080';
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU');
}

// –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
map.on('click', function(e) {
  if (isBlocked) {
    alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
    return;
  }
  
  if (!bounds.contains(e.latlng)) {
    alert('–û—Ç–º–µ—Ç–∫–∏ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∫–∞!');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  currentClickCoords = e.latlng;
  showTreeModal();
});

function showTreeModal() {
  document.getElementById('treeModal').classList.add('show');
}

function closeTreeModal() {
  document.getElementById('treeModal').classList.remove('show');
  currentClickCoords = null;
}

function selectTreeType(type) {
  if (!currentClickCoords) return;
  
  closeTreeModal();
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  const comment = prompt(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ "${type}" (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):`, "") || "";
  
  addPoint(currentClickCoords.lat, currentClickCoords.lng, type, comment);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.getElementById('treeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeTreeModal();
  }
});

function addPoint(lat, lng, type, comment) {
  const params = new URLSearchParams({
    action: 'add',
    user_id: userId,
    user_name: userName,
    lat: lat,
    lng: lng,
    type: type,
    comment: comment
  });
  
  fetch(API_URL + '?' + params.toString())
  .then(response => response.json())
  .then(result => {
    if (result.result === 'success') {
      alert(`–°–ø–∞—Å–∏–±–æ! –û—Ç–º–µ—Ç–∫–∞ "${type}" –¥–æ–±–∞–≤–ª–µ–Ω–∞.`);
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + (result.error || '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑'));
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.');
  });
}

function updateStatus(id, status) {
  if (!isAdmin) {
    alert('–ù–µ—Ç –ø—Ä–∞–≤');
    return;
  }
  
  const params = new URLSearchParams({
    action: 'update',
    id: id,
    status: status
  });
  
  fetch(API_URL + '?' + params.toString())
  .then(response => response.json())
  .then(result => {
    if (result.result === 'updated') {
      alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}

function deletePoint(id) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) return;
  
  const params = new URLSearchParams({
    action: 'delete',
    id: id
  });
  
  fetch(API_URL + '?' + params.toString())
  .then(response => response.json())
  .then(result => {
    if (result.result === 'deleted') {
      alert('–û—Ç–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}

function blockUser(targetUserId, userName) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?\n\n–û–Ω –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç–º–µ—Ç–∫–∏.`)) {
    return;
  }
  
  const params = new URLSearchParams({
    action: 'block_user',
    target_user_id: targetUserId
  });
  
  fetch(API_URL + '?' + params.toString())
  .then(response => response.json())
  .then(result => {
    if (result.result === 'blocked') {
      alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}
</script>

</body>
</html>
