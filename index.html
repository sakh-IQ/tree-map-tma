<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    .custom-popup {
      font-size: 14px;
      max-width: 250px;
    }
    .popup-btn {
      display: inline-block;
      margin: 4px 2px;
      padding: 6px 10px;
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .popup-btn:hover {
      background: #0056b3;
    }
    .popup-btn.danger {
      background: #dc3545;
    }
    .popup-btn.danger:hover {
      background: #c82333;
    }
    .popup-btn.success {
      background: #28a745;
    }
    .popup-btn.success:hover {
      background: #218838;
    }
    .popup-btn.warning {
      background: #ffc107;
      color: #212529;
    }
    .popup-btn.warning:hover {
      background: #e0a800;
    }
    .blocked-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #dc3545;
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 2000;
    }
    .status-legend {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 12px;
      z-index: 1000;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 2px 0;
    }
    .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 5px;
      border: 2px solid #333;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="status-legend">
  <div class="legend-item">
    <div class="legend-color" style="background: yellow;"></div>
    <span>–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: red;"></div>
    <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
  </div>
  <div class="legend-item">
    <div class="legend-color" style="background: green;"></div>
    <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbzA8pg-nk46U9a8bc4GPGMVLg8k5PhrvLR0rlBB6Uq_RBBwI9KL_at30X-pL3B_kYI/exec';
const tg = window.Telegram.WebApp;
const userId = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.id : 0;
const userName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';

let isUserBlocked = false;
let isAdmin = false;

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Web App
tg.ready();
tg.expand();

// –¶–µ–Ω—Ç—Ä –ø–∞—Ä–∫–∞
var map = L.map('map').setView([46.963983, 142.753996], 17);

// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –ø–∞—Ä–∫–∞
var bounds = L.latLngBounds(
  L.latLng(46.966238, 142.747308), // —Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥
  L.latLng(46.961201, 142.760771)  // —é–≥–æ-–≤–æ—Å—Ç–æ–∫
);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
loadData();

function loadData() {
  fetch(API_URL + '?user_id=' + userId)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        alert('–û—à–∏–±–∫–∞: ' + data.error);
        return;
      }
      
      isUserBlocked = data.isBlocked;
      isAdmin = data.isAdmin;
      
      if (isUserBlocked) {
        showBlockedMessage();
        return;
      }
      
      displayPoints(data.points);
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
    });
}

function displayPoints(points) {
  // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  points.forEach(pt => {
    const color = getColor(pt.status);
    const marker = L.circleMarker([pt.lat, pt.lng], {
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 8,
      weight: 2
    }).addTo(map);

    let popupContent = `<div class="custom-popup">
      <b>–¢–∏–ø:</b> ${pt.type}<br/>
      <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${pt.comment || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}<br/>
      <b>–°—Ç–∞—Ç—É—Å:</b> ${pt.status}<br/>
      <b>–î–∞—Ç–∞:</b> ${formatDate(pt.date)}<br/>
      <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_name || 'ID: ' + pt.user_id}<br/>`;

    if (isAdmin) {
      popupContent += `<hr style="margin: 8px 0;">
        <div style="text-align: center;">
          <button class="popup-btn success" onclick="updateStatus(${pt.id}, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
          <button class="popup-btn" onclick="updateStatus(${pt.id}, '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ')">üîß –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</button><br/>
          <button class="popup-btn danger" onclick="deletePoint(${pt.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
          <button class="popup-btn warning" onclick="blockUser(${pt.user_id})">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>`;
    }

    popupContent += `</div>`;
    marker.bindPopup(popupContent);
  });
}

function showBlockedMessage() {
  const blockedDiv = document.createElement('div');
  blockedDiv.className = 'blocked-message';
  blockedDiv.innerHTML = `
    <h3>–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</h3>
    <p>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.</p>
    <p>–î–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
  `;
  document.body.appendChild(blockedDiv);
}

function getColor(status) {
  switch(status) {
    case '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ': return '#FFA500'; // –û—Ä–∞–Ω–∂–µ–≤—ã–π
    case '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': return '#FF0000'; // –ö—Ä–∞—Å–Ω—ã–π
    case '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ': return '#00FF00'; // –ó–µ–ª—ë–Ω—ã–π
    default: return '#808080'; // –°–µ—Ä—ã–π
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU') + ' ' + date.toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'});
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
map.on('click', function(e) {
  if (isUserBlocked) {
    alert('–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ—á–∫–∏.');
    return;
  }
  
  const lat = e.latlng.lat;
  const lng = e.latlng.lng;
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∫–∞
  if (!bounds.contains(e.latlng)) {
    alert('–ú–æ–∂–Ω–æ –æ—Ç–º–µ—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–µ—Ä–µ–≤—å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∫–∞!');
    return;
  }
  
  const types = ['–ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ', '–ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ', '–ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ', '–û–ø–∞—Å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ'];
  let selectedType = null;
  
  // –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä —Ç–∏–ø–∞
  const typeChoice = prompt(
    `–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º—ã (–≤–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä):\n1. –ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ\n2. –ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ\n3. –ü–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ\n4. –û–ø–∞—Å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ`,
    '1'
  );
  
  if (!typeChoice || typeChoice < 1 || typeChoice > 4) {
    return;
  }
  
  selectedType = types[parseInt(typeChoice) - 1];
  const comment = prompt("–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):", "") || "";
  
  addPoint(lat, lng, selectedType, comment);
});

function addPoint(lat, lng, type, comment) {
  const data = {
    action: 'add',
    user_id: userId,
    user_name: userName,
    lat: lat,
    lng: lng,
    type: type,
    comment: comment
  };
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify(data),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === 'success') {
      alert('–°–ø–∞—Å–∏–±–æ! –û—Ç–º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞. ID: ' + data.id);
      loadData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö');
  });
}

function updateStatus(id, status) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'update',
      id: id,
      status: status
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === 'updated') {
      alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
  });
}

function deletePoint(id) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) {
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'delete',
      id: id
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === 'deleted') {
      alert('–û—Ç–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
  });
}

function blockUser(targetUserId) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'block_user',
      target_user_id: targetUserId
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === 'blocked') {
      alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
    }
  })
  .catch(error => {
    console.error('–û—à–∏–±–∫–∞:', error);
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(loadData, 30000);
</script>

</body>
</html>
