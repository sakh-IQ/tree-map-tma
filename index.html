<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–µ—Ä–µ–≤—å–µ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding-bottom: 80px;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    /* –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã */
    #map {
      opacity: 0;
      animation: fadeIn 0.5s ease-in-out forwards;
    }
    
    @keyframes fadeIn {
      to { opacity: 1; }
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º attribution OpenStreetMap –ø–æ–¥ –Ω–∞—à–µ–π –ø–∞–Ω–µ–ª—å—é */
    .leaflet-control-attribution {
      position: fixed !important;
      bottom: -50px !important;
      z-index: 500 !important;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ä–µ–≤–∞ */
    .tree-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    
    .tree-modal.show {
      display: flex;
      animation: modalAppear 0.3s ease-out;
    }
    
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 320px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      position: relative;
    }
    
    .tree-icon {
      font-size: 60px;
      margin-bottom: 15px;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
    }
    
    .tree-option {
      display: block;
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      background: white;
      font-size: 16px;
      font-weight: 500;
      color: #2c3e50;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .tree-option:hover {
      border-color: #3498db;
      background: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
    }
    
    .tree-option.infected {
      border-color: #e74c3c;
    }
    
    .tree-option.infected:hover {
      border-color: #c0392b;
      background: #fdf2f2;
      box-shadow: 0 5px 15px rgba(231, 76, 60, 0.2);
    }
    
    .tree-option.dead {
      border-color: #f39c12;
    }
    
    .tree-option.dead:hover {
      border-color: #d68910;
      background: #fef9e7;
      box-shadow: 0 5px 15px rgba(243, 156, 18, 0.2);
    }
    
    .option-emoji {
      font-size: 24px;
      margin-right: 10px;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #95a5a6;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .close-modal:hover {
      color: #7f8c8d;
    }

    .custom-popup {
      font-size: 14px;
      max-width: 250px;
      font-family: inherit;
      line-height: 1.4;
    }
    .custom-popup b {
      color: #2c3e50;
    }
    .custom-popup hr {
      border: none;
      height: 1px;
      background: linear-gradient(to right, transparent, #ddd, transparent);
    }

    .popup-btn {
      display: inline-block;
      margin: 4px 2px;
      padding: 8px 12px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .popup-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .popup-btn:active {
      transform: translateY(0);
    }
    .popup-btn.danger {
      background: #e74c3c;
    }
    .popup-btn.success {
      background: #27ae60;
    }
    .popup-btn.warning {
      background: #f39c12;
      color: white;
    }

    .status-legend {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      font-size: 14px;
      z-index: 1000;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: wrap;
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 4px 8px;
      background: rgba(255,255,255,0.15);
      padding: 8px 12px;
      border-radius: 25px;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .legend-item:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 8px;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .app-title {
      font-weight: 600;
      font-size: 16px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
      letter-spacing: 0.5px;
    }
    .help-text {
      font-size: 12px; 
      opacity: 0.9;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }
    
    /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–Ω–æ */
    .debug-panel {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.9);
      color: #00ff00;
      padding: 10px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 11px;
      z-index: 2500;
      max-width: 280px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #333;
      display: none;
    }
    
    .debug-panel.show {
      display: block;
    }
    
    .debug-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      background: #ff4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 2600;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- –ö–Ω–æ–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
<button class="debug-toggle" onclick="toggleDebug()">DEBUG</button>

<!-- –ü–∞–Ω–µ–ª—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
<div class="debug-panel" id="debugPanel">
  <div style="color: #ffff00; margin-bottom: 5px;">üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê</div>
  <div id="debugMessages"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –¥–µ—Ä–µ–≤–∞ -->
<div class="tree-modal" id="treeModal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeTreeModal()">&times;</button>
    <div class="tree-icon">üå≥</div>
    <div class="modal-title">–ß—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å —Å –¥–µ—Ä–µ–≤–æ–º?</div>
    
    <button class="tree-option infected" onclick="selectTreeType('–ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">ü¶†</span>
      –ó–∞—Ä–∞–∂—ë–Ω–Ω–æ–µ –¥–µ—Ä–µ–≤–æ
    </button>
    
    <button class="tree-option dead" onclick="selectTreeType('–ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ')">
      <span class="option-emoji">üçÇ</span>
      –ó–∞—Å–æ—Ö—à–µ–µ –¥–µ—Ä–µ–≤–æ
    </button>
    

  </div>
</div>

<div class="status-legend">
  <div class="app-title">üå≥ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ—Ä–µ–≤—å–µ–≤</div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FFA500;"></div>
    <span>–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #FF0000;"></div>
    <span>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</span>
  </div>
  
  <div class="legend-item">
    <div class="legend-color" style="background: #00AA00;"></div>
    <span>–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
  </div>
  
  <div class="help-text">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –ù–û–í–´–ô URL!!!
const API_URL = 'https://script.google.com/macros/s/AKfycbxWOFDhSaGNFyL6hdoCRsEQwt8YGgfjgNhaswPVEPaGhLcaAFNh_D8rbNwbkP1novM/exec';

const tg = window.Telegram?.WebApp || {};
const userId = tg.initDataUnsafe?.user?.id || 0;
const userName = tg.initDataUnsafe?.user?.first_name || '–ì–æ—Å—Ç—å';

let isAdmin = false;
let isBlocked = false;
let currentClickCoords = null;
let debugMessages = [];
let debugEnabled = false;

// –§—É–Ω–∫—Ü–∏—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
function debugLog(message) {
  console.log(message);
  
  if (debugEnabled) {
    const timestamp = new Date().toLocaleTimeString();
    debugMessages.push(`${timestamp}: ${message}`);
    
    // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 —Å–æ–æ–±—â–µ–Ω–∏–π
    if (debugMessages.length > 20) {
      debugMessages = debugMessages.slice(-20);
    }
    
    const debugDiv = document.getElementById('debugMessages');
    if (debugDiv) {
      debugDiv.innerHTML = debugMessages.join('<br>');
      debugDiv.scrollTop = debugDiv.scrollHeight;
    }
  }
}

function toggleDebug() {
  debugEnabled = !debugEnabled;
  const panel = document.getElementById('debugPanel');
  const button = document.querySelector('.debug-toggle');
  
  if (debugEnabled) {
    panel.classList.add('show');
    button.textContent = '–°–ö–†–´–¢–¨';
    button.style.background = '#00aa00';
    debugLog('–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞');
  } else {
    panel.classList.remove('show');
    button.textContent = 'DEBUG';
    button.style.background = '#ff4444';
  }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram
if (tg.ready) {
  tg.ready();
  tg.expand();
}

// –í–∫–ª—é—á–∞–µ–º DEBUG –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
debugEnabled = true;
document.getElementById('debugPanel').classList.add('show');
document.querySelector('.debug-toggle').textContent = '–°–ö–†–´–¢–¨';
document.querySelector('.debug-toggle').style.background = '#00aa00';

debugLog(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${userName} (ID: ${userId})`);
debugLog(`API URL: ${API_URL.substring(0, 50)}...`);
debugLog(`Telegram WebApp –¥–æ—Å—Ç—É–ø–µ–Ω: ${!!window.Telegram?.WebApp}`);
debugLog(`User data: ${JSON.stringify(tg.initDataUnsafe?.user || '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö')}`);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
var map = L.map('map').setView([46.963983, 142.753996], 17);

var bounds = L.latLngBounds(
  L.latLng(46.966238, 142.747308),
  L.latLng(46.961201, 142.760771)
);

map.setMaxBounds(bounds);
map.on('drag', function() {
  map.panInsideBounds(bounds, { animate: false });
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
loadData();

function loadData() {
  debugLog('üîÑ –ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ...');
  debugLog(`üì° –ó–∞–ø—Ä–æ—Å –∫: ${API_URL}?user_id=${userId}`);
  
  fetch(API_URL + '?user_id=' + userId)
    .then(response => {
      debugLog(`üì° –°—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status} ${response.statusText}`);
      debugLog(`üì° Content-Type: ${response.headers.get('content-type')}`);
      
      // –ß–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      return response.text().then(text => {
        debugLog(`üìÑ –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∏ (–ø–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤): ${text.substring(0, 200)}...`);
        try {
          const json = JSON.parse(text);
          return json;
        } catch (e) {
          debugLog(`‚ùå –û—à–∏–±–∫–∞ JSON –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: ${e.message}`);
          throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${text.substring(0, 100)}...`);
        }
      });
    })
    .then(data => {
      debugLog(`üìä –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏: ${JSON.stringify(data, null, 2)}`);
      
      isAdmin = data.isAdmin;
      isBlocked = data.isBlocked;
      
      debugLog(`üë§ –ê–¥–º–∏–Ω: ${isAdmin}, –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${isBlocked}`);
      debugLog(`üìç –¢–æ—á–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${data.points ? data.points.length : 0}`);
      
      if (isBlocked) {
        debugLog('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
        alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∑–∞ –Ω–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª.');
        return;
      }
      
      displayPoints(data.points || []);
    })
    .catch(error => {
      debugLog(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`);
      debugLog(`‚ùå Stack: ${error.stack}`);
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
      alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
    });
}

function displayPoints(points) {
  // –û—á–∏—â–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã
  map.eachLayer(function(layer) {
    if (layer instanceof L.CircleMarker) {
      map.removeLayer(layer);
    }
  });
  
  points.forEach(pt => {
    const color = getColor(pt.status);
    const marker = L.circleMarker([pt.lat, pt.lng], {
      color: color,
      fillColor: color,
      fillOpacity: 0.7,
      radius: 8,
      weight: 2
    }).addTo(map);

    let popupContent = `<div class="custom-popup">
      <b>–¢–∏–ø:</b> ${pt.type}<br/>
      <b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</b> ${pt.comment || '–ù–µ—Ç'}<br/>
      <b>–°—Ç–∞—Ç—É—Å:</b> ${pt.status}<br/>
      <b>–î–∞—Ç–∞:</b> ${formatDate(pt.date)}<br/>
      <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> ${pt.user_name || 'ID: ' + pt.user_id}<br/>`;

    if (isAdmin) {
      popupContent += `<hr style="margin: 8px 0;">
        <button class="popup-btn success" onclick="updateStatus(${pt.id}, '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ')">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="popup-btn" onclick="updateStatus(${pt.id}, '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ')">üîß –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ</button><br/>
        <button class="popup-btn danger" onclick="deletePoint(${pt.id})">üóë –£–¥–∞–ª–∏—Ç—å</button>
        <button class="popup-btn warning" onclick="blockUser(${pt.user_id}, '${pt.user_name}')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`;
    }

    popupContent += `</div>`;
    marker.bindPopup(popupContent);
  });
}

function getColor(status) {
  switch(status) {
    case '–ü–æ–¥–æ–∑—Ä–µ–Ω–∏–µ': return '#FFA500';
    case '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ': return '#FF0000';
    case '–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ': return '#00AA00';
    default: return '#808080';
  }
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('ru-RU');
}

// –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
map.on('click', function(e) {
  debugLog(`üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ: ${e.latlng.lat}, ${e.latlng.lng}`);
  
  if (isBlocked) {
    debugLog('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
    alert('–í–∞—à –∞–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
    return;
  }
  
  if (!bounds.contains(e.latlng)) {
    debugLog('‚ùå –ö–ª–∏–∫ –≤–Ω–µ –≥—Ä–∞–Ω–∏—Ü –ø–∞—Ä–∫–∞');
    alert('–û—Ç–º–µ—Ç–∫–∏ –º–æ–∂–Ω–æ —Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –ø–∞—Ä–∫–∞!');
    return;
  }
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
  currentClickCoords = e.latlng;
  debugLog(`üíæ –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: ${currentClickCoords.lat}, ${currentClickCoords.lng}`);
  
  debugLog('üé® –ü–æ–∫–∞–∑—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
  showTreeModal();
});

function showTreeModal() {
  debugLog('üì± –û—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
  document.getElementById('treeModal').classList.add('show');
}

function closeTreeModal() {
  debugLog('‚ùå –ó–∞–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
  document.getElementById('treeModal').classList.remove('show');
  currentClickCoords = null;
}

function selectTreeType(type) {
  debugLog(`üéØ –í—ã–±—Ä–∞–Ω —Ç–∏–ø: ${type}`);
  
  if (!currentClickCoords) {
    debugLog('‚ùå –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç!');
    alert('–û—à–∏–±–∫–∞: –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
    return;
  }
  
  debugLog(`üìç –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${currentClickCoords.lat}, ${currentClickCoords.lng}`);
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –î–û –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const lat = currentClickCoords.lat;
  const lng = currentClickCoords.lng;
  
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ (—ç—Ç–æ –æ–±–Ω—É–ª–∏—Ç currentClickCoords)
  closeTreeModal();
  
  // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
  const comment = prompt(`–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ "${type}" (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):`, "") || "";
  debugLog(`üí¨ –í–≤–µ–¥–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: "${comment}"`);
  
  debugLog(`üöÄ –ì–æ—Ç–æ–≤ –≤—ã–∑–≤–∞—Ç—å addPoint —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:`);
  debugLog(`- lat: ${lat}, lng: ${lng}`);
  debugLog(`- type: ${type}, comment: ${comment}`);
  
  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ—á–∫—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
  addPoint(lat, lng, type, comment);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.getElementById('treeModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeTreeModal();
  }
});

function addPoint(lat, lng, type, comment) {
  debugLog(`üå≥ –î–æ–±–∞–≤–ª—è—é —Ç–æ—á–∫—É: ${type}`);
  debugLog(`üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${lat}, ${lng}`);
  debugLog(`üë§ User ID: ${userId}, User Name: ${userName}`);
  debugLog(`üîó API URL: ${API_URL}`);
  
  try {
    const data = {
      action: 'add',
      user_id: userId,
      user_name: userName,
      lat: lat,
      lng: lng,
      type: type,
      comment: comment
    };
    
    debugLog(`üì¶ –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏: ${JSON.stringify(data, null, 2)}`);
    debugLog(`üì° –û—Ç–ø—Ä–∞–≤–ª—è—é POST-–∑–∞–ø—Ä–æ—Å –Ω–∞ ${API_URL}...`);
    
    fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: {
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      debugLog(`üì° –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: ${response.status} ${response.statusText}`);
      debugLog(`üì° Headers: ${JSON.stringify([...response.headers])}`);
      
      // –ß–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ —Ç–µ–∫—Å—Ç —Å–Ω–∞—á–∞–ª–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      return response.text().then(text => {
        debugLog(`üìÑ –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç: ${text}`);
        try {
          const json = JSON.parse(text);
          return json;
        } catch (e) {
          debugLog(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${e.message}`);
          throw new Error(`–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON: ${text.substring(0, 100)}...`);
        }
      });
    })
    .then(result => {
      debugLog(`‚úÖ –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${JSON.stringify(result, null, 2)}`);
      
      if (result.result === 'success') {
        debugLog(`üéâ –£—Å–ø–µ—Ö! ID: ${result.id}`);
        alert(`–°–ø–∞—Å–∏–±–æ! –û—Ç–º–µ—Ç–∫–∞ "${type}" –¥–æ–±–∞–≤–ª–µ–Ω–∞. ID: ${result.id}`);
        setTimeout(() => loadData(), 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
      } else if (result.error) {
        debugLog(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞: ${result.error}`);
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + result.error);
      } else {
        debugLog(`‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç: ${JSON.stringify(result)}`);
        alert('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
      }
    })
    .catch(error => {
      debugLog(`‚ùå –û—à–∏–±–∫–∞ fetch: ${error.message}`);
      debugLog(`‚ùå Stack trace: ${error.stack}`);
      alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message);
    });
    
  } catch (error) {
    debugLog(`‚ùå –û—à–∏–±–∫–∞ –≤ addPoint: ${error.message}`);
    debugLog(`‚ùå Stack trace: ${error.stack}`);
    alert('–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ' + error.message);
  }
}

function updateStatus(id, status) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'update',
      id: id,
      status: status
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'updated') {
      alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}

function deletePoint(id) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) return;
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'delete',
      id: id
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'deleted') {
      alert('–û—Ç–º–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞!');
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}

function blockUser(targetUserId, userName) {
  if (!isAdmin) {
    alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤');
    return;
  }
  
  if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${userName}"?\n\n–û–Ω –±–æ–ª—å—à–µ –Ω–µ —Å–º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç–º–µ—Ç–∫–∏.`)) {
    return;
  }
  
  fetch(API_URL, {
    method: 'POST',
    body: JSON.stringify({
      action: 'block_user',
      target_user_id: targetUserId
    }),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(result => {
    if (result.result === 'blocked') {
      alert(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${userName}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
      loadData();
    } else {
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ');
    }
  })
  .catch(error => {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
setInterval(loadData, 30000);
</script>

</body>
</html>
